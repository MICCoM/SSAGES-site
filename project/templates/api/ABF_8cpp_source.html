<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>SSAGES: /home/cody/SSAGES/src/Methods/ABF.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">SSAGES
   &#160;<span id="projectnumber">0.1</span>
   </div>
   <div id="projectbrief">A MetaDynamics Package</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_f757fd908aef964c55548e00ebc4a256.html">Methods</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">ABF.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;ABF.h&quot;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &quot;CVs/CVManager.h&quot;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &quot;Drivers/DriverException.h&quot;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;Validator/ObjectRequirement.h&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &quot;Snapshot.h&quot;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &quot;schema.h&quot;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;algorithm&gt;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">using namespace </span>Json;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">// &quot;Adaptive biasing force method for scalar and vector free energy calculations&quot;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">// Darve, Rodriguez-Gomez, Pohorille</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">// J. Chem. Phys. (2008)</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keyword">namespace </span>SSAGES</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;{</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    <span class="comment">// Pre-simulation hook.</span></div>
<div class="line"><a name="l00039"></a><span class="lineno"><a class="line" href="classSSAGES_1_1ABF.html#a27d1b2f056d32066d7c62a037836948c">   39</a></span>&#160;    <span class="keywordtype">void</span> ABF::PreSimulation(<a class="code" href="classSSAGES_1_1Snapshot.html">Snapshot</a>* snapshot, <span class="keyword">const</span> <a class="code" href="classSSAGES_1_1CVManager.html">CVManager</a>&amp; cvmanager)</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    {</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;        </div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;        <span class="comment">// Open/close outfile to create it fresh. </span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;        <span class="keywordflow">if</span>(world_.rank() == 0)</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;        {</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;            worldout_.open(filename_);</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;            worldout_.close();</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;        }</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;        </div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;        <span class="comment">// Convenience. Number of CVs.</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;        <span class="keyword">auto</span> cvs = cvmanager.<a class="code" href="classSSAGES_1_1CVManager.html#a7317d7a4400d1c6ece08559f146dc049">GetCVs</a>(cvmask_);</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;        dim_ = cvs.size();</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;        <span class="comment">// Size and initialize Fold_</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;        Fold_.setZero(dim_);</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;        </div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;        <span class="comment">// Size and initialize Fworld_ and Nworld_      </span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        <span class="keyword">auto</span> nel = 1;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <span class="comment">// Initialize biases.</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        biases_.resize(snapshot-&gt;<a class="code" href="classSSAGES_1_1Snapshot.html#aee2ceb317884bc5e0105b9824b5026d3">GetPositions</a>().size(), <a class="code" href="namespaceSSAGES.html#a630084a0a5e185e89e21b3735f8f8b2e">Vector3</a>{0, 0, 0});</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        </div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        <span class="comment">// Initialize w \dot p&#39;s for finite difference. </span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        wdotp1_.setZero(dim_);</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        wdotp2_.setZero(dim_);  </div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    }</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div>
<div class="line"><a name="l00076"></a><span class="lineno"><a class="line" href="classSSAGES_1_1ABF.html#ad2007ce8bb539072a97d4d02d268c638">   76</a></span>&#160;    <span class="keywordtype">void</span> ABF::PostIntegration(<a class="code" href="classSSAGES_1_1Snapshot.html">Snapshot</a>* snapshot, <span class="keyword">const</span> <a class="code" href="classSSAGES_1_1CVManager.html">CVManager</a>&amp; cvmanager)</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    {</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        </div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        ++iteration_;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        <span class="comment">// Gather information.</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        <span class="keyword">auto</span> cvs = cvmanager.<a class="code" href="classSSAGES_1_1CVManager.html#a7317d7a4400d1c6ece08559f146dc049">GetCVs</a>(cvmask_);</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        <span class="keyword">auto</span>&amp; vels = snapshot-&gt;<a class="code" href="classSSAGES_1_1Snapshot.html#aeadc50cebd62e3fcbdc17511f781de19">GetVelocities</a>();</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        <span class="keyword">auto</span>&amp; mass = snapshot-&gt;<a class="code" href="classSSAGES_1_1Snapshot.html#a035ed6fb2cd46d4f66d1614bd90ad14b">GetMasses</a>();</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        <span class="keyword">auto</span>&amp; forces = snapshot-&gt;<a class="code" href="classSSAGES_1_1Snapshot.html#a2533f7b900bc33185424eb94d6996edf">GetForces</a>();</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        <span class="keyword">auto</span> n = snapshot-&gt;<a class="code" href="classSSAGES_1_1Snapshot.html#ae05879b78672cd4899a06ae2d6a140fd">GetNumAtoms</a>();</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        </div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        <span class="comment">//int coord = histCoords(cvs);</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        Eigen::MatrixXd J(dim_, 3*n);</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        </div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        std::vector&lt;double&gt; cvVals(dim_);</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        <span class="comment">// Fill J and CV. Each column represents grad(CV) with flattened Cartesian elements. </span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; dim_; ++i)</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        {</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;            <span class="keyword">auto</span>&amp; grad = cvs[i]-&gt;GetGradient();</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> j = 0; j &lt; n; ++j)</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;                J.block&lt;1, 3&gt;(i,3*j) = grad[j];</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;            cvVals[i] = cvs[i]-&gt;GetValue();</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        }</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        <span class="comment">//* Calculate W using Darve&#39;s approach (http://mc.stanford.edu/cgi-bin/images/0/06/Darve_2008.pdf).</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        Eigen::MatrixXd Jmass = J.transpose();</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        <span class="keywordflow">if</span>(massweigh_)</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        {</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0; i &lt; forces.size(); ++i)</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                Jmass.block(3*i, 0, 3, dim_) = Jmass.block(3*i, 0, 3, dim_)/mass[i];</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        }</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        Eigen::MatrixXd Minv = J*Jmass;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        MPI_Allreduce(MPI_IN_PLACE, Minv.data(), Minv.size(), MPI_DOUBLE, MPI_SUM, comm_);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        Eigen::MatrixXd Wt = Minv.inverse()*Jmass.transpose();  </div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        <span class="comment">// Fill momenta.</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        Eigen::VectorXd momenta(3*vels.size());</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0; i &lt; vels.size(); ++i)</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;            momenta.segment&lt;3&gt;(3*i) = mass[i]*vels[i];</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        </div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        <span class="comment">// Compute dot(w,p)</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        Eigen::VectorXd wdotp = Wt*momenta;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        </div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        <span class="comment">// Reduce dot product across processors.</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        MPI_Allreduce(MPI_IN_PLACE, wdotp.data(), wdotp.size(), MPI_DOUBLE, MPI_SUM, comm_);</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        </div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    </div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        <span class="comment">// Compute d(wdotp)/dt second order backwards finite difference. </span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <span class="comment">// Adding old force removes bias. </span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        Eigen::VectorXd dwdotpdt = unitconv_*(1.5*wdotp - 2.0*wdotp1_ + 0.5*wdotp2_)/timestep_ + Fold_;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        <span class="comment">// If we are in bounds, sum force into running total.</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        <span class="keywordflow">if</span>(boundsCheck(cvVals))</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        {</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i=0; i&lt;dim_; ++i)</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                F_[i]-&gt;at(cvVals) += dwdotpdt[i];</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;            N_-&gt;at(cvVals)++;               </div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        }</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        </div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="comment">// Reduce data across processors.</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i=0; i&lt;dim_; ++i)                </div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;            MPI_Allreduce(F_[i]-&gt;data(), Fworld_[i]-&gt;data(), (F_[i]-&gt;size()), MPI_DOUBLE, MPI_SUM, world_); </div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        MPI_Allreduce(N_-&gt;data(), Nworld_-&gt;data(), N_-&gt;size(), MPI_INT, MPI_SUM, world_);</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="comment">// If we are in bounds, store the old summed force.</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        <span class="keywordflow">if</span>(boundsCheck(cvVals))</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        {</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i=0; i &lt; dim_; ++i)</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;                Fold_[i] = Fworld_[i]-&gt;at(cvVals)/std::max(min_, Nworld_-&gt;at(cvVals));</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        }</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    </div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <span class="comment">// Update finite difference time derivatives.</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        wdotp2_ = wdotp1_;</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        wdotp1_ = wdotp;        </div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <span class="comment">// Write out data to file.</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        <span class="keywordflow">if</span>(iteration_ % FBackupInterv_ == 0)</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            WriteData();</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        <span class="comment">// Calculate the bias from averaged F at current CV coordinates.</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <span class="comment">// Or apply harmonic restraints to return CVs back in bounds.</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        CalcBiasForce(snapshot, cvs, cvVals);       </div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        <span class="comment">// Update the forces in snapshot by adding in the force bias from each</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        <span class="comment">// CV to each atom based on the gradient of the CV.</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j = 0; j &lt; forces.size(); ++j)</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;            forces[j] += biases_[j];    </div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    }</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="comment">// Post-simulation hook.</span></div>
<div class="line"><a name="l00174"></a><span class="lineno"><a class="line" href="classSSAGES_1_1ABF.html#a02fae49d009dcf405d82144a2d123faa">  174</a></span>&#160;    <span class="keywordtype">void</span> ABF::PostSimulation(<a class="code" href="classSSAGES_1_1Snapshot.html">Snapshot</a>*, <span class="keyword">const</span> <a class="code" href="classSSAGES_1_1CVManager.html">CVManager</a>&amp;)</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    {</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        WriteData();</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    }</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div>
<div class="line"><a name="l00179"></a><span class="lineno"><a class="line" href="classSSAGES_1_1ABF.html#aa2200677359f582d73f095c42ec5ad83">  179</a></span>&#160;    <span class="keywordtype">void</span> ABF::CalcBiasForce(<span class="keyword">const</span> <a class="code" href="classSSAGES_1_1Snapshot.html">Snapshot</a>* snapshot, <span class="keyword">const</span> <a class="code" href="namespaceSSAGES.html#acddea47426ac0a643b048f870ddd2907">CVList</a>&amp; cvs, <span class="keyword">const</span> std::vector&lt;double&gt; &amp;cvVals)</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    {</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        <span class="comment">// Reset the bias.</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        biases_.resize(snapshot-&gt;<a class="code" href="classSSAGES_1_1Snapshot.html#ae05879b78672cd4899a06ae2d6a140fd">GetNumAtoms</a>(), <a class="code" href="namespaceSSAGES.html#a630084a0a5e185e89e21b3735f8f8b2e">Vector3</a>{0,0,0});</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        <span class="keywordflow">for</span>(<span class="keyword">auto</span>&amp; b : biases_)</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;            b.setZero();</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        </div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        <span class="comment">// Compute bias if within bounds.</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        <span class="keywordflow">if</span>(boundsCheck(cvVals))</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        {</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; dim_; ++i)</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;            {</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;                <span class="keyword">auto</span>&amp; grad = cvs[i]-&gt;GetGradient();</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> j = 0; j &lt; biases_.size(); ++j)</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                    biases_[j] -= (Fworld_[i]-&gt;at(cvVals))*grad[j]/std::max(min_,Nworld_-&gt;at(cvVals));</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;            }</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        }</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        <span class="comment">// Otherwise, apply harmonic restraint if enabled.</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        {</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; dim_; ++i)</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;            {</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;                <span class="keywordtype">double</span> cvVal = cvs[i]-&gt;GetValue();</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                <span class="keyword">auto</span> k = 0.;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                <span class="keyword">auto</span> x0 = 0.;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                </div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                <span class="keywordflow">if</span>(isperiodic_[i])</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;                {</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;                    <span class="keywordtype">double</span> periodsize = periodicboundaries_[i][1]-periodicboundaries_[i][0];</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                    <span class="keywordtype">double</span> cvRestrMidpoint = (restraint_[i][1]+restraint_[i][0])/2;</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;                    <span class="keywordflow">while</span>((cvVal-cvRestrMidpoint) &gt; periodsize/2)</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                        cvVal -= periodsize;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                    <span class="keywordflow">while</span>((cvVal-cvRestrMidpoint) &lt; -periodsize/2)</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                        cvVal += periodsize;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                }</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;                <span class="keywordflow">if</span>(cvVal &lt; restraint_[i][0] &amp;&amp; restraint_[i][2] &gt; 0)</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                {</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                    k = restraint_[i][2];</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;                    x0 = restraint_[i][0];</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                }</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cvVal &gt; restraint_[i][1] &amp;&amp; restraint_[i][2] &gt; 0)</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;                {</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                    k = restraint_[i][2];</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                    x0 = restraint_[i][1];</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;                }</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                <span class="keyword">auto</span>&amp; grad = cvs[i]-&gt;GetGradient();</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> j = 0; j &lt; biases_.size(); ++j)</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                    biases_[j] -= (cvVal - x0)*k*grad[j];</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;            }   </div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        }</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    }</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="comment">// Write out the average generalized force.</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    <span class="comment">// Also write out Fworld and Nworld backups for restarts.</span></div>
<div class="line"><a name="l00235"></a><span class="lineno"><a class="line" href="classSSAGES_1_1ABF.html#ab63434a1cefe80372e2555e1128e39d2">  235</a></span>&#160;    <span class="keywordtype">void</span> ABF::WriteData()</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    {</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        <span class="comment">// Only one processor should be performing I/O.</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        <span class="keywordflow">if</span>(world_.rank() != 0)</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        <span class="comment">// Backup Fworld and Nworld.</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        Nworld_-&gt;WriteToFile(Nworld_filename_);</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0 ; i &lt; dim_; ++i)</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        {</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;            Fworld_[i]-&gt;WriteToFile(Fworld_filename_+std::to_string(i));</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        }</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        </div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        <span class="comment">// Average the generalized force for each bin and print it out. </span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        <span class="keywordtype">int</span> gridPoints = 1;         </div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0 ; i &lt; dim_; ++i)</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;            gridPoints = gridPoints * N_-&gt;GetNumPoints(i);</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        worldout_.open(filename_,std::ios::out);</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        worldout_ &lt;&lt; std::endl;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        worldout_ &lt;&lt; <span class="stringliteral">&quot;Iteration: &quot;</span> &lt;&lt; iteration_ &lt;&lt; std::endl;          </div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        worldout_ &lt;&lt; <span class="stringliteral">&quot;Printing out the current Adaptive Biasing Vector Field.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        worldout_ &lt;&lt; <span class="stringliteral">&quot;First (Nr of CVs) columns are the coordinates, the next (Nr of CVs) columns are components of the Adaptive Force vector at that point.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        worldout_ &lt;&lt; <span class="stringliteral">&quot;The columns are &quot;</span> &lt;&lt; gridPoints &lt;&lt; <span class="stringliteral">&quot; long, mapping out a surface of &quot;</span>;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        </div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0 ; i &lt; dim_-1; ++i)</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;            worldout_ &lt;&lt; (N_-&gt;GetNumPoints())[i] &lt;&lt; <span class="stringliteral">&quot; by &quot;</span> ;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        worldout_ &lt;&lt; (N_-&gt;GetNumPoints(dim_-1)) &lt;&lt; <span class="stringliteral">&quot; points in &quot;</span> &lt;&lt; dim_ &lt;&lt; <span class="stringliteral">&quot; dimensions.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        worldout_ &lt;&lt; std::endl; </div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        std::vector&lt;int&gt; printCoords(dim_);</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        <span class="keywordtype">int</span> div = 1;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        <span class="keywordtype">int</span> index = 0;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        std::vector&lt;double&gt; tempcoord(dim_);</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0; i &lt; gridPoints; ++i)</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        {</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;            printCoords[0] = i%(Nworld_-&gt;GetNumPoints(0));</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;            div = 1;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> j = 1; j &lt; dim_; ++j)</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;            {</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                div = div * Nworld_-&gt;GetNumPoints(j);</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                printCoords[j]=i/div;                       </div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;            }</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> j = 0; j &lt; dim_; ++j)</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;            {</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                worldout_ &lt;&lt; std::setw(10) &lt;&lt; (printCoords[j]+0.5)*((Nworld_-&gt;GetUpper(j)-Nworld_-&gt;GetLower(j))/Nworld_-&gt;GetNumPoints(j)) + Nworld_-&gt;GetLower(j) &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                tempcoord[j] = ((printCoords[j]+0.5)*((Nworld_-&gt;GetUpper(j)-Nworld_-&gt;GetLower(j))/Nworld_-&gt;GetNumPoints(j)) + Nworld_-&gt;GetLower(j));</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;            }</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> j = 0; j &lt; dim_; ++j)</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;            {</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                worldout_ &lt;&lt;  std::setw(10) &lt;&lt; (Fworld_[j]-&gt;at(tempcoord))/std::max(Nworld_-&gt;at(tempcoord),min_)&lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;            }</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;            worldout_ &lt;&lt; std::endl;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;            </div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        }</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        worldout_ &lt;&lt; std::endl;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        worldout_ &lt;&lt; std::endl;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        worldout_.close();</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    }</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    </div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    <span class="comment">// Checks whether walker is within CV bounds.</span></div>
<div class="line"><a name="l00298"></a><span class="lineno"><a class="line" href="classSSAGES_1_1ABF.html#ae223e09cc686522073fd881088edb8ac">  298</a></span>&#160;    <span class="keywordtype">bool</span> ABF::boundsCheck(<span class="keyword">const</span> std::vector&lt;double&gt; &amp;CVs)</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    {</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0; i &lt; dim_ ; ++i)</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        {</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;            <span class="keywordflow">if</span>((CVs[i] &lt; N_-&gt;GetLower(i)) || (CVs[i] &gt; N_-&gt;GetUpper(i)))</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;            {</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;            }</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;        }</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    }</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;</div>
<div class="line"><a name="l00311"></a><span class="lineno"><a class="line" href="classSSAGES_1_1ABF.html#aa131b026ddb40941889c8bde7840ac6a">  311</a></span>&#160;    <a class="code" href="classSSAGES_1_1ABF.html">ABF</a>* ABF::Build(<span class="keyword">const</span> Value&amp; json, </div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                        <span class="keyword">const</span> MPI_Comm&amp; world,</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                        <span class="keyword">const</span> MPI_Comm&amp; comm,</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                        <span class="keyword">const</span> std::string&amp; path)</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    {</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        <a class="code" href="classJson_1_1ObjectRequirement.html">ObjectRequirement</a> validator;</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        Value schema;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        Reader reader;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        </div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        reader.parse(JsonSchema::ABFMethod, schema);</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        validator.<a class="code" href="classJson_1_1ObjectRequirement.html#a4ed02ae1d612a5efba1688fcdd2df092">Parse</a>(schema, path);</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        <span class="comment">// Validate inputs.</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        validator.<a class="code" href="classJson_1_1ObjectRequirement.html#a9ac3b920001a35bc70580035d8d802b7">Validate</a>(json, path);</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        <span class="keywordflow">if</span>(validator.<a class="code" href="classJson_1_1Requirement.html#adfaec336a9f051d6f6b9a6d7f1d97b75">HasErrors</a>())</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="classSSAGES_1_1BuildException.html">BuildException</a>(validator.<a class="code" href="classJson_1_1Requirement.html#a60bc275c366eb59f192fa2e621268480">GetErrors</a>());</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        uint wid = mxx::comm(world).rank()/mxx::comm(comm).size(); </div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        <span class="comment">//bool multiwalkerinput = false;</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        <span class="comment">// Obtain lower bound for each CV.</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        std::vector&lt;double&gt; minsCV;</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        <span class="keywordflow">for</span>(<span class="keyword">auto</span>&amp; mins : json[<span class="stringliteral">&quot;CV_lower_bounds&quot;</span>])</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;            <span class="keywordflow">if</span>(mins.isArray())</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                {</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                <span class="keywordflow">throw</span> <a class="code" href="classSSAGES_1_1BuildException.html">BuildException</a>({<span class="stringliteral">&quot;Separate inputs for multi-walker not fully implemented. Please use global entries for CV ranges&quot;</span>});</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                <span class="comment">//multiwalkerinput = true;</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                <span class="comment">//for(auto&amp; bound : mins)</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                <span class="comment">//  minsCV.push_back(bound.asDouble());</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                }</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                minsCV.push_back(mins.asDouble());</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;            </div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        <span class="comment">// Obtain upper bound for each CV.</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        std::vector&lt;double&gt; maxsCV;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        <span class="keywordflow">for</span>(<span class="keyword">auto</span>&amp; maxs : json[<span class="stringliteral">&quot;CV_upper_bounds&quot;</span>])</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;            <span class="comment">/*if(maxs.isArray())</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="comment">                {</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="comment">                for(auto&amp; bound : maxs)</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="comment">                    maxsCV.push_back(bound.asDouble());</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="comment">                }*/</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;            <span class="comment">//else</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                maxsCV.push_back(maxs.asDouble());</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        <span class="comment">// Obtain number of bins for each CV dimension.</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        std::vector&lt;int&gt; binsCV;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        <span class="keywordflow">for</span>(<span class="keyword">auto</span>&amp; bins : json[<span class="stringliteral">&quot;CV_bins&quot;</span>])</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;            binsCV.push_back(bins.asInt());</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <span class="comment">// Obtain lower bounds for restraints for each CV.</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        std::vector&lt;double&gt; minsrestCV;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        <span class="keywordflow">for</span>(<span class="keyword">auto</span>&amp; mins : json[<span class="stringliteral">&quot;CV_restraint_minimums&quot;</span>])</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;            <span class="comment">/*if(mins.isArray())</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="comment">                {</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="comment">                for(auto&amp; bound : mins)</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="comment">                    minsrestCV.push_back(bound.asDouble());</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;<span class="comment">                }*/</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;            <span class="comment">//else</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                minsrestCV.push_back(mins.asDouble());</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        <span class="comment">// Obtain upper bounds for restraints for each CV.      </span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        std::vector&lt;double&gt; maxsrestCV;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;        <span class="keywordflow">for</span>(<span class="keyword">auto</span>&amp; maxs : json[<span class="stringliteral">&quot;CV_restraint_maximums&quot;</span>])</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            <span class="comment">/*if(maxs.isArray())</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="comment">                {</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="comment">                for(auto&amp; bound : maxs)</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="comment">                    maxsrestCV.push_back(bound.asDouble());</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="comment">                }*/</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;            <span class="comment">//else</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                maxsrestCV.push_back(maxs.asDouble());</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        </div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        <span class="comment">// Obtain harmonic spring constant for restraints for each CV.</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        std::vector&lt;double&gt; springkrestCV;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;        <span class="keywordflow">for</span>(<span class="keyword">auto</span>&amp; bins : json[<span class="stringliteral">&quot;CV_restraint_spring_constants&quot;</span>])</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;            springkrestCV.push_back(bins.asDouble());</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        <span class="comment">// Obtain periodicity information for restraints for each CV for the purpose of correctly applying restraints through periodic boundaries.</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        std::vector&lt;bool&gt; isperiodic;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        <span class="keywordflow">for</span>(<span class="keyword">auto</span>&amp; isperCV : json[<span class="stringliteral">&quot;CV_isperiodic&quot;</span>])</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;            isperiodic.push_back(isperCV.asBool());</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;        </div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        <span class="comment">// Obtain lower periodic boundary for each CV.</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        std::vector&lt;double&gt; minperboundaryCV;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        <span class="keywordflow">for</span>(<span class="keyword">auto</span>&amp; minsperCV : json[<span class="stringliteral">&quot;CV_periodic_boundary_lower_bounds&quot;</span>])</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;            minperboundaryCV.push_back(minsperCV.asDouble());</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        <span class="comment">// Obtain upper periodic boundary for each CV.</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        std::vector&lt;double&gt; maxperboundaryCV;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        <span class="keywordflow">for</span>(<span class="keyword">auto</span>&amp; maxsperCV : json[<span class="stringliteral">&quot;CV_periodic_boundary_upper_bounds&quot;</span>])</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;            maxperboundaryCV.push_back(maxsperCV.asDouble());</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        <span class="comment">// Verify inputs are all correct lengths.</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;        <span class="keywordflow">if</span>(!((   minsCV.size() == maxsCV.size() &amp;&amp; </div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;             maxsCV.size() == minsrestCV.size() &amp;&amp;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;             minsrestCV.size() == maxsrestCV.size()) &amp;&amp;</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;            (binsCV.size() == springkrestCV.size() &amp;&amp;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;             springkrestCV.size() == isperiodic.size())))       </div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;            <span class="keywordflow">throw</span> <a class="code" href="classSSAGES_1_1BuildException.html">BuildException</a>({<span class="stringliteral">&quot;CV lower bounds, upper bounds, restrain minimums, restrains maximums must match in size. Bins, spring constants and periodicity info must match in size.&quot;</span>});</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        <span class="comment">// Verify that all periodicity information is provided if CVs are periodic.</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        <span class="keywordtype">bool</span> anyperiodic=<span class="keyword">false</span>;</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0; i&lt;isperiodic.size(); ++i)</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;            <span class="keywordflow">if</span>(isperiodic[i])</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;            {</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                anyperiodic = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                <span class="keywordflow">if</span>(!(isperiodic.size() == minperboundaryCV.size() &amp;&amp;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;                     minperboundaryCV.size() == maxperboundaryCV.size()))</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                    <span class="keywordflow">throw</span> <a class="code" href="classSSAGES_1_1BuildException.html">BuildException</a>({<span class="stringliteral">&quot;If any CV is defined as periodic, please define the full upper and lower bound vectors. They should both have the same number of entries as CV lower bounds, upper bounds... Entries corresponding to non-periodic CVs will not be used.&quot;</span>});</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            }</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;        <span class="keywordtype">int</span> dim = binsCV.size();</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        </div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        <span class="comment">// Read in JSON info.</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        <span class="keyword">auto</span> FBackupInterv = json.get(<span class="stringliteral">&quot;output_frequency&quot;</span>, 1000).asInt();</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        <span class="keyword">auto</span> unitconv = json.get(<span class="stringliteral">&quot;unit_conversion&quot;</span>, 0).asDouble();</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;        <span class="keyword">auto</span> timestep = json.get(<span class="stringliteral">&quot;timestep&quot;</span>, 2).asDouble();</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        <span class="keyword">auto</span> min = json.get(<span class="stringliteral">&quot;minimum_count&quot;</span>, 200).asDouble();</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        <span class="keyword">auto</span> massweigh = json.get(<span class="stringliteral">&quot;mass_weighing&quot;</span>,<span class="keyword">false</span>).asBool();          </div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        std::vector&lt;std::vector&lt;double&gt;&gt; histdetails;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        std::vector&lt;std::vector&lt;double&gt;&gt; restraint;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;        std::vector&lt;std::vector&lt;double&gt;&gt; periodicboundaries;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        std::vector&lt;double&gt; temp1(3);</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        std::vector&lt;double&gt; temp2(3);</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        std::vector&lt;double&gt; temp3(2);</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        <span class="keyword">auto</span> freq = json.get(<span class="stringliteral">&quot;frequency&quot;</span>, 1).asInt();</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        <span class="keyword">auto</span> filename = json.get(<span class="stringliteral">&quot;output_file&quot;</span>, <span class="stringliteral">&quot;F_out&quot;</span>).asString();</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;        <span class="keyword">auto</span> Nworld_filename = json.get(<span class="stringliteral">&quot;Nworld_output_file&quot;</span>, <span class="stringliteral">&quot;Nworld&quot;</span>).asString();</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        <span class="keyword">auto</span> Fworld_filename = json.get(<span class="stringliteral">&quot;Fworld_output_file&quot;</span>, <span class="stringliteral">&quot;Fworld_cv&quot;</span>).asString();</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        <span class="comment">// Generate the grids based on JSON.</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        <a class="code" href="classSSAGES_1_1Grid.html">Grid&lt;int&gt;</a> *N;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        <a class="code" href="classSSAGES_1_1Grid.html">Grid&lt;int&gt;</a> *Nworld;</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        std::vector&lt;Grid&lt;double&gt;*&gt; F(dim);</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        std::vector&lt;Grid&lt;double&gt;*&gt; Fworld(dim);</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        <span class="comment">// This feature is disabled for now.</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;        <span class="comment">/*if(multiwalkerinput)</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;<span class="comment">        {</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;<span class="comment">            for(size_t i=0; i&lt;dim; ++i)</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;<span class="comment">            {</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="comment">                temp1 = {minsCV[i+wid*dim], maxsCV[i+wid*dim], binsCV[i]};</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;<span class="comment">                temp2 = {minsrestCV[i+wid*dim], maxsrestCV[i+wid*dim], springkrestCV[i]};</span></div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="comment">                histdetails.push_back(temp1);</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="comment">                restraint.push_back(temp2);</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;<span class="comment">                if(anyperiodic)</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;<span class="comment">                {</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="comment">                    temp3 = {minperboundaryCV[i], maxperboundaryCV[i]};</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="comment">                    periodicboundaries.push_back(temp3);</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="comment">                }</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="comment">            }</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="comment">            for(size_t i=0; i&lt;dim; ++i)</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="comment">            {</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="comment">                minsCVperwalker[i] = histdetails[i][0];</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;<span class="comment">                maxsCVperwalker[i] = histdetails[i][1];</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="comment">            }</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;<span class="comment">            N= new Grid&lt;int&gt;(binsCV, minsCVperwalker, maxsCVperwalker, isperiodic);</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;<span class="comment">            Nworld= new Grid&lt;int&gt;(binsCV, minsCVperwalker, maxsCVperwalker, isperiodic);</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;<span class="comment">            </span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="comment">            for(auto&amp; grid : F)</span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;<span class="comment">            {</span></div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;<span class="comment">                grid= new Grid&lt;double&gt;(binsCV, minsCVperwalker, maxsCVperwalker, isperiodic);</span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;<span class="comment">            }</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;<span class="comment">            for(auto&amp; grid : Fworld)</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="comment">            {</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="comment">                grid= new Grid&lt;double&gt;(binsCV, minsCVperwalker, maxsCVperwalker, isperiodic);</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;<span class="comment">            }</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="comment">            </span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="comment">        }</span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;        <span class="comment">//else</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        <span class="comment">//{</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        </div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        <span class="comment">// Appropriately size the grids.</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i=0; i&lt;dim; ++i) </div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        </div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;            N= <span class="keyword">new</span> <a class="code" href="classSSAGES_1_1Grid.html">Grid&lt;int&gt;</a>(binsCV, minsCV, maxsCV, isperiodic);</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;            Nworld= <span class="keyword">new</span> <a class="code" href="classSSAGES_1_1Grid.html">Grid&lt;int&gt;</a>(binsCV, minsCV, maxsCV, isperiodic);</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;            </div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;            <span class="keywordflow">for</span>(<span class="keyword">auto</span>&amp; grid : F)</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;            {</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                grid= <span class="keyword">new</span> <a class="code" href="classSSAGES_1_1Grid.html">Grid&lt;double&gt;</a>(binsCV, minsCV, maxsCV, isperiodic);</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;            }</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;            <span class="keywordflow">for</span>(<span class="keyword">auto</span>&amp; grid : Fworld)</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;            {</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                grid= <span class="keyword">new</span> <a class="code" href="classSSAGES_1_1Grid.html">Grid&lt;double&gt;</a>(binsCV, minsCV, maxsCV, isperiodic);</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;            }</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i=0; i&lt;dim; ++i)</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;            {</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                temp1 = {minsCV[i], maxsCV[i], binsCV[i]};</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                temp2 = {minsrestCV[i], maxsrestCV[i], springkrestCV[i]};</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                histdetails.push_back(temp1);</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                restraint.push_back(temp2);</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                <span class="keywordflow">if</span>(anyperiodic)</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                {</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;                    temp3 = {minperboundaryCV[i], maxperboundaryCV[i]};</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                    periodicboundaries.push_back(temp3);</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                }</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;            }</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;        <span class="comment">//}</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;        <span class="comment">// Check if previously saved grids exist. If so, check that data match and load grids.</span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        <span class="keywordflow">if</span>(std::ifstream(Nworld_filename) &amp;&amp; std::ifstream(Fworld_filename+std::to_string(0)) &amp;&amp; wid == 0)</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;        {</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;            std::cout &lt;&lt; <span class="stringliteral">&quot;Attempting to load data from a previous run of ABF.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;            N-&gt;<a class="code" href="classSSAGES_1_1Grid.html#a279c1e9005fdf4c6fc23358d51b75b86">LoadFromFile</a>(Nworld_filename);</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;            <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i=0; i&lt;dim; ++i)</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                <span class="keywordflow">if</span>(std::ifstream(Fworld_filename+std::to_string(i)))</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;                    F[i]-&gt;LoadFromFile(Fworld_filename+std::to_string(i));</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                    <span class="keywordflow">throw</span> <a class="code" href="classSSAGES_1_1BuildException.html">BuildException</a>({<span class="stringliteral">&quot;Some, but not all Fworld outputs were found. Please check that these are appropriate inputs, or clean the working directory of other Fworld and Nworld inputs.&quot;</span>});</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;        }</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;     </div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        </div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;        <span class="keyword">auto</span>* m = <span class="keyword">new</span> <a class="code" href="classSSAGES_1_1ABF.html">ABF</a>(world, comm, N, Nworld, F, Fworld, restraint, isperiodic, periodicboundaries, min, massweigh, filename, Nworld_filename, Fworld_filename, histdetails, FBackupInterv, unitconv, timestep, freq);</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        <span class="keywordflow">if</span>(json.isMember(<span class="stringliteral">&quot;iteration&quot;</span>))</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;            m-&gt;SetIteration(json.get(<span class="stringliteral">&quot;iteration&quot;</span>,0).asInt());</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        <span class="keywordflow">return</span> m;</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        </div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    }</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;}</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;</div>
<div class="ttc" id="classJson_1_1Requirement_html_adfaec336a9f051d6f6b9a6d7f1d97b75"><div class="ttname"><a href="classJson_1_1Requirement.html#adfaec336a9f051d6f6b9a6d7f1d97b75">Json::Requirement::HasErrors</a></div><div class="ttdeci">bool HasErrors()</div><div class="ttdoc">Check if errors have occured. </div><div class="ttdef"><b>Definition:</b> <a href="Requirement_8h_source.html#l00086">Requirement.h:86</a></div></div>
<div class="ttc" id="classSSAGES_1_1CVManager_html"><div class="ttname"><a href="classSSAGES_1_1CVManager.html">SSAGES::CVManager</a></div><div class="ttdoc">Collective variable manager. </div><div class="ttdef"><b>Definition:</b> <a href="CVManager_8h_source.html#l00040">CVManager.h:40</a></div></div>
<div class="ttc" id="classSSAGES_1_1Snapshot_html_ae05879b78672cd4899a06ae2d6a140fd"><div class="ttname"><a href="classSSAGES_1_1Snapshot.html#ae05879b78672cd4899a06ae2d6a140fd">SSAGES::Snapshot::GetNumAtoms</a></div><div class="ttdeci">unsigned GetNumAtoms() const </div><div class="ttdoc">Get number of atoms in this snapshot. </div><div class="ttdef"><b>Definition:</b> <a href="Snapshot_8h_source.html#l00200">Snapshot.h:200</a></div></div>
<div class="ttc" id="namespaceSSAGES_html_acddea47426ac0a643b048f870ddd2907"><div class="ttname"><a href="namespaceSSAGES.html#acddea47426ac0a643b048f870ddd2907">SSAGES::CVList</a></div><div class="ttdeci">std::vector&lt; CollectiveVariable * &gt; CVList</div><div class="ttdoc">List of Collective Variables. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00051">types.h:51</a></div></div>
<div class="ttc" id="classSSAGES_1_1Snapshot_html"><div class="ttname"><a href="classSSAGES_1_1Snapshot.html">SSAGES::Snapshot</a></div><div class="ttdoc">Class containing a snapshot of the current simulation in time. </div><div class="ttdef"><b>Definition:</b> <a href="Snapshot_8h_source.html#l00043">Snapshot.h:43</a></div></div>
<div class="ttc" id="classSSAGES_1_1Grid_html"><div class="ttname"><a href="classSSAGES_1_1Grid.html">SSAGES::Grid&lt; int &gt;</a></div></div>
<div class="ttc" id="classJson_1_1ObjectRequirement_html_a4ed02ae1d612a5efba1688fcdd2df092"><div class="ttname"><a href="classJson_1_1ObjectRequirement.html#a4ed02ae1d612a5efba1688fcdd2df092">Json::ObjectRequirement::Parse</a></div><div class="ttdeci">virtual void Parse(Value json, const std::string &amp;path) override</div><div class="ttdoc">Parse JSON value to generate Requirement(s). </div><div class="ttdef"><b>Definition:</b> <a href="ObjectRequirement_8h_source.html#l00142">ObjectRequirement.h:142</a></div></div>
<div class="ttc" id="classSSAGES_1_1BuildException_html"><div class="ttname"><a href="classSSAGES_1_1BuildException.html">SSAGES::BuildException</a></div><div class="ttdoc">Exception to be thrown when building the Driver fails. </div><div class="ttdef"><b>Definition:</b> <a href="DriverException_8h_source.html#l00038">DriverException.h:38</a></div></div>
<div class="ttc" id="classJson_1_1Requirement_html_a60bc275c366eb59f192fa2e621268480"><div class="ttname"><a href="classJson_1_1Requirement.html#a60bc275c366eb59f192fa2e621268480">Json::Requirement::GetErrors</a></div><div class="ttdeci">std::vector&lt; std::string &gt; GetErrors()</div><div class="ttdoc">Get list of error messages. </div><div class="ttdef"><b>Definition:</b> <a href="Requirement_8h_source.html#l00092">Requirement.h:92</a></div></div>
<div class="ttc" id="classSSAGES_1_1CVManager_html_a7317d7a4400d1c6ece08559f146dc049"><div class="ttname"><a href="classSSAGES_1_1CVManager.html#a7317d7a4400d1c6ece08559f146dc049">SSAGES::CVManager::GetCVs</a></div><div class="ttdeci">std::vector&lt; CollectiveVariable * &gt; GetCVs(const std::vector&lt; uint &gt; &amp;mask=std::vector&lt; uint &gt;()) const </div><div class="ttdoc">Get CV iterator. </div><div class="ttdef"><b>Definition:</b> <a href="CVManager_8h_source.html#l00080">CVManager.h:80</a></div></div>
<div class="ttc" id="classSSAGES_1_1Snapshot_html_a035ed6fb2cd46d4f66d1614bd90ad14b"><div class="ttname"><a href="classSSAGES_1_1Snapshot.html#a035ed6fb2cd46d4f66d1614bd90ad14b">SSAGES::Snapshot::GetMasses</a></div><div class="ttdeci">const std::vector&lt; double &gt; &amp; GetMasses() const </div><div class="ttdoc">Const access to the particle masses. </div><div class="ttdef"><b>Definition:</b> <a href="Snapshot_8h_source.html#l00378">Snapshot.h:378</a></div></div>
<div class="ttc" id="classSSAGES_1_1ABF_html"><div class="ttname"><a href="classSSAGES_1_1ABF.html">SSAGES::ABF</a></div><div class="ttdoc">Adaptive Biasing Force Algorithm. </div><div class="ttdef"><b>Definition:</b> <a href="ABF_8h_source.html#l00042">ABF.h:42</a></div></div>
<div class="ttc" id="classJson_1_1ObjectRequirement_html"><div class="ttname"><a href="classJson_1_1ObjectRequirement.html">Json::ObjectRequirement</a></div><div class="ttdoc">Requirements on an object. </div><div class="ttdef"><b>Definition:</b> <a href="ObjectRequirement_8h_source.html#l00046">ObjectRequirement.h:46</a></div></div>
<div class="ttc" id="namespaceSSAGES_html_a630084a0a5e185e89e21b3735f8f8b2e"><div class="ttname"><a href="namespaceSSAGES.html#a630084a0a5e185e89e21b3735f8f8b2e">SSAGES::Vector3</a></div><div class="ttdeci">Eigen::Vector3d Vector3</div><div class="ttdoc">Three-dimensional vector. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00033">types.h:33</a></div></div>
<div class="ttc" id="classSSAGES_1_1Snapshot_html_aeadc50cebd62e3fcbdc17511f781de19"><div class="ttname"><a href="classSSAGES_1_1Snapshot.html#aeadc50cebd62e3fcbdc17511f781de19">SSAGES::Snapshot::GetVelocities</a></div><div class="ttdeci">const std::vector&lt; Vector3 &gt; &amp; GetVelocities() const </div><div class="ttdoc">Access the particle velocities. </div><div class="ttdef"><b>Definition:</b> <a href="Snapshot_8h_source.html#l00349">Snapshot.h:349</a></div></div>
<div class="ttc" id="classSSAGES_1_1Grid_html_a279c1e9005fdf4c6fc23358d51b75b86"><div class="ttname"><a href="classSSAGES_1_1Grid.html#a279c1e9005fdf4c6fc23358d51b75b86">SSAGES::Grid::LoadFromFile</a></div><div class="ttdeci">void LoadFromFile(const std::string &amp;filename)</div><div class="ttdoc">Builds a grid from file. </div><div class="ttdef"><b>Definition:</b> <a href="Grid_8h_source.html#l00626">Grid.h:626</a></div></div>
<div class="ttc" id="classSSAGES_1_1Snapshot_html_a2533f7b900bc33185424eb94d6996edf"><div class="ttname"><a href="classSSAGES_1_1Snapshot.html#a2533f7b900bc33185424eb94d6996edf">SSAGES::Snapshot::GetForces</a></div><div class="ttdeci">const std::vector&lt; Vector3 &gt; &amp; GetForces() const </div><div class="ttdoc">Access the per-particle forces. </div><div class="ttdef"><b>Definition:</b> <a href="Snapshot_8h_source.html#l00362">Snapshot.h:362</a></div></div>
<div class="ttc" id="classSSAGES_1_1Snapshot_html_aee2ceb317884bc5e0105b9824b5026d3"><div class="ttname"><a href="classSSAGES_1_1Snapshot.html#aee2ceb317884bc5e0105b9824b5026d3">SSAGES::Snapshot::GetPositions</a></div><div class="ttdeci">const std::vector&lt; Vector3 &gt; &amp; GetPositions() const </div><div class="ttdoc">Access the particle positions. </div><div class="ttdef"><b>Definition:</b> <a href="Snapshot_8h_source.html#l00323">Snapshot.h:323</a></div></div>
<div class="ttc" id="classJson_1_1ObjectRequirement_html_a9ac3b920001a35bc70580035d8d802b7"><div class="ttname"><a href="classJson_1_1ObjectRequirement.html#a9ac3b920001a35bc70580035d8d802b7">Json::ObjectRequirement::Validate</a></div><div class="ttdeci">virtual void Validate(const Value &amp;json, const std::string &amp;path) override</div><div class="ttdoc">Validate JSON value. </div><div class="ttdef"><b>Definition:</b> <a href="ObjectRequirement_8h_source.html#l00239">ObjectRequirement.h:239</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Aug 1 2017 13:08:23 for SSAGES by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.7
</small></address>
</body>
</html>
